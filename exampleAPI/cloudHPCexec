#!/bin/bash

###############################################################################
#
#   Script developped in 2020 by
#   CFD FEA SERVICE SRL - via Borgo Grande 19, 37044 Cologna Veneta VR
#
#   License: GPLv3
#
###############################################################################

#TODO default OpenFOAM CFD  -> sceglie la macchina e PRE
#TODO default Snappy   MESH -> sceglie la macchina e PRE

#OPTIONS and INSTRUCTIONS #####################################################
option=""
if [ ! $# -eq 0 ]
then
   option=$1
fi

#DOWNLOADING RECENT VERSION OF SCRIPT #########################################
if [ "$option" = "-update" ]
then
   #Updating to new version and installation
   echo "Checking for updates & installation ..."
   wget https://raw.githubusercontent.com/CFD-FEA-SERVICE/CloudHPC/master/exampleAPI/cloudHPCexec
   chmod ugo+x cloudHPCexec
   sudo rm /usr/local/bin/cloudHPCexec
   sudo mv cloudHPCexec /usr/local/bin

   #setting autocomplete
   sudo sh -c "echo '#/usr/bin/env bash'                                                  > /etc/bash_completion.d/cloudHPCexec"
   sudo sh -c "echo 'complete -W \"-apikey -help -mesh -update -download\" cloudHPCexec' >> /etc/bash_completion.d/cloudHPCexec"

   echo "#####################################################################"
   echo "cloudHPCexec updated and installed successfully - Available for usage"
   echo "#####################################################################"

   exit
fi

#APIKEY RESET #################################################################
if [ "$option" = "-apikey" ]
then
   echo "APIKEY reset ..."
   rm -rf $HOME/.cfscloudhpc/apikey
fi

#HELP OPTIONS #################################################################
if [ "$option" = "-help" ]
then
   echo "List of options available:"
   echo "CLOUDHPC OPTIONS  ###################################################"
   echo "-download         Download results from STORAGE"
   echo "-mesh             Select mesh directory"
   echo ""
   echo "SCRIPT MANAGEMENT ###################################################"
   echo "-apikey           Reset your APIKEY"
   echo "-update           Update the software"
   echo "-help             Return this menu"
   exit
fi

#CHECKING EXTRA PACKAGES TO INSTALL############################################
if [ -z $(command -v dialog) ]
then
   sudo apt-get install dialog
fi
if [ -z $(command -v jq) ]
then
   sudo apt-get install jq
fi
if [ -z $(command -v pigz) ]
then
   sudo apt-get install pigz
fi

#GETTING/STORING APIKEY #######################################################
if [ -f $HOME/.cfscloudhpc/apikey ]
then
   apikey=$(head -n 1 $HOME/.cfscloudhpc/apikey)
else
   read -e -p "Insert APIKEY: " apikey
   mkdir $HOME/.cfscloudhpc
   echo "$apikey" > $HOME/.cfscloudhpc/apikey
fi

#DOWNLOAD RESULTS #############################################################
if [ "$option" = "-download" ]
then
   #PART 1 -> selection of folder to download TAR.GZ files from
   folder_storage_options=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/0/list \
                           -H "api-key: $apikey" \
  			   --header 'Accept: application/json' 2> log.tmp | python -m json.tool | jq .[].basename| tr -d \" )

   folder_storage_options=($(echo $folder_storage_options | tr " " "\n"))

   folder_options=()
   count=0

   for i in "${folder_storage_options[@]}"
   do :
   	count=$[count+1]
   	folder_options+=( ${count} $i )
   done

   folder_storage_number=$(dialog --clear --nocancel --menu "Pick the FOLDER" 13 60 19 "${folder_options[@]}" 2>&1 >/dev/tty)

   #PART 2  > selections of all files inside folder ending with "TAR.GZ"
   folder_id=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/0/list \
                                   -H "api-key: $apikey" \
				   --header 'Accept: application/json' 2> log.tmp | python -m json.tool | jq .[$(($folder_storage_number - 1))].id )

   file_ids=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/$folder_id/list \
                                   -H "api-key: $apikey" \
				   --header 'Accept: application/json' 2> log.tmp | python -m json.tool | \
				    jq '.[] | .basename , .id' | grep 'tar.gz\|rmed' -A 1 | grep -v 'tar.gz' | grep -v 'rmed' | grep -v '\-\-' )

   file_ids=($(echo $file_ids | tr " " "\n"))

   #PART 3 > downloading selected files
   for file in "${file_ids[@]}"
   do : 
      url=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/$file/download/url \
                   -H "api-key: $apikey" \
                   -H 'Content-Type: application/json' \
		   -H 'Accept: application/json'  2> log.tmp | python -m json.tool | jq .url | sed 's/"//g' )

      wget $url
   done

   rm log.tmp

   exit
fi

#EXECUTION AND API CALL #######################################################
FOLDER=$(basename $(pwd))

cpuoptions=(  1 "1 CPU" \
              2 "2 CPU" \
              4 "4 CPU" \
              8 "8 CPU" \
            16 "16 CPU" \
            32 "32 CPU" \
	    64 "64 CPU" \
	    96 "96 CPU" \
	   128 "128 CPU" \
	   224 "224 CPU" )

cpu=$(dialog --clear --nocancel --menu "Pick the CPU you need" 15 60 12 "${cpuoptions[@]}" 2>&1 >/dev/tty)

ramoptions=( standard "4 Gb per CPU" highcpu "1 Gb per CPU" highmem "8 GB per CPU" )
ram=$(dialog --clear --nocancel --menu "Pick the RAM you need" 11 60 12 "${ramoptions[@]}" 2>&1 >/dev/tty)

scriptoptions=( openFoam-of7      "OpenFOAM v7"      \
		snappyHexMesh-of7 "snappyHexMesh v7" \
		openFoam-v1912    "openFoam-v1912"   \
	       	codeAster-14.4    "Code_Aster v14.4" \
	       	codeSaturne-5.2   "Code_Saturne v5.2" \
	       	fds6.7.4          "FDS v6.7.4"       \
	       	fds6.7.1          "FDS v6.7.1"       \
	       	fds6.7.0          "FDS v6.7.0"        )

script=$(dialog --clear --nocancel --menu "Pick the solver you use" 13 60 12 "${scriptoptions[@]}" 2>&1 >/dev/tty)

#FOLDER LIST EXTRACTION FROM CLOUD [MESH PART] ################################
if [ "$option" = "-mesh" ]
then
   folder_storage_options=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/0/list \
                           -H "api-key: $apikey" \
  			   --header 'Accept: application/json' 2> log.tmp | python -m json.tool | jq .[].basename| tr -d \" )

   folder_storage_options=($(echo $folder_storage_options | tr " " "\n"))

   folder_options=()
   count=0

   for i in "${folder_storage_options[@]}"
   do :
   	count=$[count+1]
   	folder_options+=( ${count} $i )
   done

   mesh_storage=$(dialog --clear --nocancel --menu "Pick the MESH FOLDER" 13 60 19 "${folder_options[@]}" 2>&1 >/dev/tty)

   mesh_storage=${folder_storage_options[$(($mesh_storage - 1))]}

else
   mesh_storage=""

fi

#SELECT CASE FOLDER ###########################################################
clear

read -e -p "Insert folder name [to use in cloud HPC]: " folder_storage

##DELETING FOLDER IF EXISTS ALREAD #############################################
#folder_id=$(curl -X GET https://cloud.cfdfeaservice.it/api/v1/storage/0/list \
#                                   -H "api-key: $apikey" \
#   				   --header 'Accept: application/json' 2> log.tmp | python -m json.tool | \
#				    jq '.[] | .basename , .id' | grep "$folder_storage" -A 1 | grep -v "$folder_storage" )
#
#if [ ! "$folder_id" = "" ]
#then
#   echo "Detected $folder_storage on STORAGE. Deleting it ..."
#   curl -X DELETE https://cloud.cfdfeaservice.it/api/v1/storage/$folder_id \
#		-H "api-key: $apikey" \
#		-H 'Accept: application/json'
#
#   sleep 10
#fi

#LOADING CURRENT FOLDER AS TAR FILE ###########################################
echo "Loading Current folder: $FOLDER / destination: $folder_storage"
tar -I pigz -cf $FOLDER.tar.gz * > log.tmp 2>&1

JSON_STRING=$( jq -n \
                  --arg dirname       "$folder_storage" \
                  --arg basename      "$FOLDER.tar.gz" \
                  --arg contentType   "application/octet-stream" \
                  '{data: {dirname: $dirname, basename: $basename, contentType: $contentType}}' )

UPLOAD_URL=$( curl -X POST \
  https://cloud.cfdfeaservice.it/api/v1/storage/upload/url \
  -H "api-key: $apikey" \
  -H 'Content-Type: application/json' \
  -H 'Accept: application/json' \
  -d "$JSON_STRING" | jq .url | tr -d \")

curl -X PUT \
  -H 'Content-Type: application/octet-stream' \
  -T $FOLDER.tar.gz $UPLOAD_URL

rm $FOLDER.tar.gz

#added sleep to avoid cache problems
sleep 10

#EXECUTE ANALYSIS #############################################################
echo "Executing $script on $cpu CPU with $ram RAM"

JSON_STRING=$( jq -n \
                  --arg cpu    "$cpu" \
                  --arg ram    "$ram" \
                  --arg script "$script" \
                  --arg folder "$folder_storage" \
                  --arg nopre  "0" \
                  --arg mesh   "$mesh_storage" \
                  '{data: {cpu: $cpu, ram: $ram, folder: $folder, script: $script, nopre: $nopre, mesh: $mesh}}' )

curl -X POST \
  https://cloud.cfdfeaservice.it/api/v1/simulation \
  -H "api-key: $apikey" \
  -H 'Content-Type: application/json' \
  -H 'Accept: application/json' \
  -d "$JSON_STRING"

rm log.tmp

echo ""
